<?php
/*
http://192.168.0.24/listings_new/convert_db_format/get_skus_linked_to_removed_listings.php

DESCRIPTION:

*/

$db = new PDO('sqlite:listings_NEW.db3');

$tbl = 'listings';
$sql = "SELECT `id_lkup` FROM `$tbl` WHERE `remove` = 1";
$results = $db->query($sql);
$removed_listings = $results->fetchAll(PDO::FETCH_COLUMN);
$removed_listings_str = implode("','", $removed_listings);

//DEBUG
// echo '<pre style="background:#111; color:#b5ce28; font-size:11px;">'; print_r($removed_listings); echo '</pre>'; die();

$removed_listings = [
  92,
  111,
  130,
  149,
  150,
  151,
  152,
  153,
  214,
  215,
  216,
  217,
  218,
  219,
  220,
  221,
  222,
  223,
  323,
  324,
  325,
  326,
  397,
  416,
  417,
  457,
  476,
  477,
  619,
  621,
  625,
  635,
  637,
  650,
  652,
  665,
  667,
  1070,
  1071,
  1102,
  1103,
  1330,
  1349,
  1367,
  1368,
  1387,
  1404,
  1405,
  1406,
  1421,
  1422,
  1423,
  1424,
  1425,
  1474,
  1475,
  1476,
  1477,
  1478,
  1479,
  1480,
  1481,
  1482,
  1483,
  1484,
  1485,
  1486,
  1487,
  1488,
  1489,
  1506,
  1507,
  1508,
  1509,
  1510,
  1511,
  1512,
  1513,
  1514,
  1515,
  1516,
  1517,
  1518,
  1519,
  1520,
  1521,
  1753,
  1754,
  1755,
  1756,
  1757,
  1758,
  1759,
  1760,
  1761,
  1762,
  1763,
  1764,
  1796,
  1797,
];

$removed_listings = [
  1798,
  1800,
  1815,
  1816,
  1817,
  1819,
  1834,
  1835,
  1836,
  1838,
  1853,
  1854,
  1855,
  1857,
  1872,
  1873,
  1874,
  1876,
  1893,
  1895,
  1897,
  1912,
  1914,
  1916,
  1931,
  1933,
  1935,
  1939,
  1978,
  1979,
  1980,
  1981,
  2015,
  2016,
  2017,
  2018,
  2019,
  2020,
  2021,
  2022,
  2023,
  2024,
  2025,
  2026,
  2027,
  2028,
  2029,
  2139,
  2140,
  2141,
  2142,
  2143,
  2144,
  2145,
  2146,
  2147,
  2148,
  2187,
  2221,
  2222,
  2223,
  2224,
  2225,
  2226,
  2227,
  2228,
  2229,
  2230,
  2231,
  2341,
  2401,
  2403,
  2404,
  2405,
  2408,
  2409,
  2415,
  2417,
  2418,
  2419,
  2924,
  2925,
  2926,
  2927,
  2928,
  2929,
  2930,
  2931,
  2932,
  2933,
  2934,
  2935,
  2936,
  2997,
  2998,
  3012,
  3013,
  3014,
  3015,
  3016,
];

$removed_listings = [
  3017,
  3018,
  3019,
  3020,
  3021,
  3022,
  3023,
  3024,
  3025,
  3026,
  3027,
  3028,
  3029,
  3030,
  3031,
  3032,
  3033,
  3034,
  3035,
  3036,
  3037,
  3038,
  3039,
  3040,
  3041,
  3042,
  3043,
  3044,
  3045,
  3046,
  3047,
  3048,
  3049,
  3050,
  3051,
  3052,
  3053,
  3054,
  3055,
  3056,
  3057,
  3058,
  3059,
  3060,
  3061,
  3062,
  3063,
  3064,
  3065,
  3066,
  3067,
  3068,
  3069,
  3070,
  3071,
  3072,
  3073,
  3079,
  3141,
  3192,
  3193,
  3205,
  3206,
  3210,
  3213,
  3214,
  3215,
  3217,
  3221,
  3222,
  3223,
  3224,
  3227,
  3228,
  3363,
  3364,
  3365,
  3366,
  3378,
  3379,
  3380,
  3381,
  3521,
  3522,
  3523,
  3524,
  3525,
  3526,
  3527,
  3528,
  3529,
  3530,
  3531,
  3532,
  3548,
  3549,
  3564,
  3565,
  3566,
  3581,
];

$removed_listings = [
  3582,
  3583,
  3599,
  3616,
  3667,
  3707,
  3708,
  3709,
  3710,
  3711,
  3712,
  3713,
  3714,
  3760,
  3762,
  3764,
  3765,
  3766,
  4297,
  4298,
  4299,
  4300,
  4301,
  4302,
  4303,
  4304,
  4305,
  4306,
  4307,
  4308,
  4309,
  4310,
  4927,
  4938,
  4949,
  4959,
  5310,
  5311,
  5312,
  5313,
  5314,
  5315,
  5316,
  5317,
  5318,
  5319,
  5364,
  5365,
  5366,
  5367,
  5368,
  5369,
  5370,
  5371,
  5372,
  5373,
  5374,
  5375,
  5376,
  5377,
  5398,
  5399,
  5400,
  5401,
  5402,
  5403,
  5404,
  5405,
  5406,
  5407,
  5408,
  5409,
  5410,
  5411,
  5412,
  5413,
  5414,
  5415,
  5416,
  5417,
  5451,
  5460,
  5461,
  5470,
  6231,
  6232,
  6233,
  6234,
  6235,
  6246,
  6247,
  6248,
  6249,
  6250,
  6261,
  6262,
  6263,
  6264,
  6265,
  6276,
];

$removed_listings = [
  6277,
  6278,
  6279,
  6280,
  6351,
  6352,
  6353,
  6354,
  6355,
  6356,
  6357,
  6358,
  6359,
  6360,
  6790,
  6791,
  6792,
  6793,
  6794,
  6795,
  6796,
  6797,
  6798,
  6799,
  6800,
  6801,
  6894,
  6895,
  6905,
  6913,
  6924,
  6946,
  6958,
  6961,
  6970,
  7006,
  7007,
  7008,
  7009,
  7010,
  7011,
  7012,
  7013,
  7014,
  7015,
  7016,
  7017,
  7018,
  7019,
  7020,
  7021,
  7022,
  7023,
  7024,
  7025,
  7026,
  7040,
  7041,
  7043,
  7045,
  7062,
  7065,
  7133,
  7247,
  7263,
  7339,
  7515,
  7517,
  7525,
  7526,
  7527,
  7528,
  7529,
  7530,
  7531,
  7532,
  7533,
  7545,
  7560,
  7581,
  7595,
  7609,
  7623,
  7637,
  7651,
  7665,
  7679,
  7693,
  7708,
  7723,
  7738,
  7753,
  7768,
  7783,
  7784,
  7814,
  7815,
  7816,
  7817,
  7818,
];

$removed_listings = [
  7819,
  7820,
  7821,
  7822,
  7823,
  7824,
  7825,
  7826,
  7827,
  7828,
  7829,
  7830,
  7831,
  7832,
  7833,
  7834,
  7925,
  8176,
  8206,
  8207,
  8208,
  8209,
  8210,
  8211,
  8212,
  8213,
  8214,
  8215,
  8216,
  8217,
  8218,
  8219,
  8220,
  8221,
  8294,
  8440,
  8520,
  8569,
  8579,
  8589,
  8599,
  8609,
  8610,
  8621,
  8647,
  8796,
  8800,
  8882,
  8883,
  8884,
  8885,
  8886,
  8979,
  9140,
  9142,
  9157,
  9158,
  9163,
  9168,
  9173,
  9178,
  9273,
  9274,
  9275,
  9276,
  9277,
  9278,
  9303,
  9320,
  9359,
  9374,
  9387,
  9393,
  9399,
  9405,
  9425,
  9432,
  9435,
  9445,
  9468,
  9469,
  9470,
  9471,
  9472,
  9473,
  9474,
  9475,
  9476,
  9477,
  9478,
  9479,
  9480,
  9481,
  9482,
  9483,
  9484,
  9485,
  9486,
  9487,
  9523,
];

$removed_listings = [
  9530,
  9569,
  9580,
  9597,
  9605,
  9606,
  9614,
  9674,
  9704,
  9726,
  9728,
  9735,
  9742,
  9749,
  9756,
  9762,
  9769,
  9776,
  9817,
  9824,
  9833,
  9845,
  9877,
  9884,
  9891,
  9906,
  9907,
  9930,
  10022,
  10023,
  10024,
  10025,
  10047,
  10048,
  10049,
  10050,
  10147,
  10148,
  10149,
  10150,
  10172,
  10173,
  10174,
  10175,
  10180,
  10181,
  10182,
  10183,
  10184,
  10185,
  10186,
  10187,
  10188,
  10189,
  10190,
  10191,
  10192,
  10193,
  10194,
  10195,
  10196,
  10197,
  10198,
  10199,
  10200,
  10201,
  10225,
  10227,
  10228,
  10254,
  10343,
  10344,
  10345,
  10346,
  10368,
  10369,
  10370,
  10371,
  10398,
  10403,
  10408,
  10433,
  10436,
  10437,
  10438,
  10439,
  10440,
  10441,
  10442,
  10443,
  10651,
  10670,
  10689,
  10727,
  10795,
  10840,
  10860,
  10861,
  10862,
  10863,
];

$removed_listings = [
  10896,
  10897,
  10898,
  10899,
  10922,
  10930,
  10931,
  10933,
  10950,
  11043,
  11044,
  11045,
  11046,
  11047,
  11048,
  11049,
  11050,
  11051,
  11052,
  11053,
  11054,
  11071,
  11075,
  11079,
  11151,
  11154,
  11179,
  11194,
  11209,
  11231,
  11245,
  11275,
  11288,
  11304,
  11306,
  11329,
  11330,
  11351,
  11411,
  11449,
  11450,
  11451,
  11452,
  11453,
  11454,
  11455,
  11456,
  11457,
  11458,
  11459,
  11460,
  11461,
  11497,
  11498,
  11500,
  11501,
  11502,
  11503,
  11504,
  11506,
  11508,
  11509,
  11510,
  11511,
  11514,
  11521,
  11522,
  11523,
  11524,
  11526,
  11527,
  11528,
  11529,
  11530,
  11532,
  11533,
  11535,
  11536,
  11538,
  11539,
  11540,
  11541,
  11542,
  11548,
  11549,
  11550,
  11551,
  11552,
  11553,
  11554,
  11555,
  11556,
  11579,
  11732,
  11733,
  11734,
  11735,
  11736,
  11737,
  11738,
];

$removed_listings = [
  11739,
  11740,
  11741,
  11742,
  11743,
  11744,
  11765,
  11775,
  11776,
  11777,
  11778,
  11779,
  11780,
  11781,
  11782,
  11783,
  11784,
  11785,
  11786,
  11829,
  11830,
  11856,
  11860,
  11981,
  11982,
  11983,
  11984,
  11985,
  11986,
  11987,
  11988,
  11989,
  11990,
  11991,
  11992,
  11993,
  11994,
  11995,
  12038,
  12039,
  12040,
  12043,
  12051,
  12052,
  12057,
  12059,
  12060,
  12061,
  12106,
  12107,
  12110,
  12195,
  12209,
  12210,
  12211,
  12212,
  12213,
  12214,
  12215,
  12234,
  12249,
  12250,
  12254,
  12270,
  12324,
  12327,
  12328,
  12329,
  12330,
  12331,
  12332,
  12333,
  12347,
  12355,
  12371,
  12373,
  12374,
  12375,
  12376,
  12437,
  12441,
  12606,
  12607,
  12608,
  12609,
  12610,
  12623,
  12624,
  12657,
  12817,
  12819,
  12894,
  12996,
  13053,
  13058,
  13067,
  13076,
  13078,
  13092,
  13112,
  13124,
  13128,
  13183,
  13239,
];
/**/

$non_reassigned_skus =[];
foreach( $removed_listings as $id ){
  $tbl = 'skus';
  $sql = "SELECT `id`,`sku`,`source` FROM `$tbl` WHERE `id` IN ('$id')";
  $results = $db->query($sql);
  $removed_skus = $results->fetchAll(PDO::FETCH_ASSOC);


  // array_filter removes empty array items
  $skus = array_filter(array_column($removed_skus, 'sku') );
  $skus_str = implode("','", $skus);

  $tbl = 'skus';
  $sql = "SELECT `sku`,`id` FROM `$tbl` WHERE `id` NOT IN ('$removed_listings_str') AND `sku` IN ('$skus_str')";
  $results = $db->query($sql);
  $reassigned_skus = $results->fetchAll(PDO::FETCH_KEY_PAIR);

  foreach( $removed_skus as $rec ){
    if( !isset($reassigned_skus[$rec['sku'] ]) && '' != $rec['sku'] ){
      $non_reassigned_skus[$rec['id'] ][] = $rec['sku'];
    }
  }
}

$csv = [];
// $csv[] = 'id,skus';
foreach( $non_reassigned_skus as $id => $skus ){
  $csv[] = "$id,".implode(',', $skus);
}

echo '<pre style="background:#111; color:#b5ce28; font-size:11px;">'; print_r( implode("\n", $csv) ); echo '</pre>';

//DEBUG
// echo '<pre style="background:#111; color:#b5ce28; font-size:11px;">'; print_r($removed_skus); echo '</pre>';
// echo '<pre style="background:#111; color:#b5ce28; font-size:11px;">'; print_r($reassigned_skus); echo '</pre>';
echo '<pre style="background:#111; color:#b5ce28; font-size:11px;">'; print_r($non_reassigned_skus); echo '</pre>';